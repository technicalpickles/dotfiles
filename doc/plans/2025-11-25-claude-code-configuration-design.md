# Claude Code Configuration Management Design

**Date:** 2025-11-25
**Status:** Validated

## Goals

- Automate Claude Code setup on fresh machines
- Synchronize settings across multiple machines
- Document configuration for reproducibility
- Keep sensitive data out of version control
- Support role-based configuration (personal vs work)

## Architecture Overview

Claude Code configuration follows the same pattern as git configuration in this repository:

### File Structure

```
dotfiles/
├── claudeconfig.sh              # Generator script (like gitconfig.sh)
├── claude/
│   ├── settings.base.json       # Core settings (statusLine, alwaysThinkingEnabled, etc.)
│   ├── settings.personal.json   # Personal role overrides
│   ├── settings.work.json       # Work role overrides
│   ├── permissions.json         # Base permissions (common tools/skills)
│   ├── permissions.personal.json # Personal-specific permissions
│   └── permissions.work.json    # Work-specific permissions
```

### Generated Files

- `~/.claude/settings.json` - Generated by merging base + role-specific settings + permissions
- Never committed, always regenerated from source

### Local-only Settings

- AWS credentials, Bedrock config, or other sensitive data
- Manually added to `~/.claude/settings.json` after generation
- Persists between regenerations (script preserves local-only keys)

### Bootstrap Process

1. Install marketplaces (idempotent)
2. Install plugins (idempotent)
3. Generate settings.json from tracked configs

## claudeconfig.sh Generation Logic

The script performs these steps:

1. **Detect role** - Use `$DOTPICKLES_ROLE` (already set by your system)
2. **Install marketplaces** - Idempotently add marketplaces using `claude marketplace add`
3. **Install plugins** - Idempotently install plugins using `claude plugin install`
4. **Merge JSON files** - Combine base + role-specific settings and permissions using `jq`
5. **Preserve local settings** - Read existing `~/.claude/settings.json`, extract local-only keys
6. **Write atomically** - Generate to temp file, validate, then move to `~/.claude/settings.json`

### Merge Order (last wins)

1. `settings.base.json` - Core settings everyone gets
2. `settings.$ROLE.json` - Role-specific overrides
3. Merged permissions from `permissions.json` + `permissions.$ROLE.json`
4. Existing local-only settings (preserved from current file)

### Local-only Key Detection

Define a list of keys considered "local-only" in the script:

- `awsAuthRefresh`
- `env`

Script extracts these from the existing file before regenerating and merges them back into the final output.

## Marketplace and Plugin Installation

Marketplaces and plugins are defined as arrays directly in `claudeconfig.sh` (following the pattern used in Fish configs):

```bash
marketplaces=(
  "superpowers-marketplace"
  "anthropic-agent-skills"
  "technicalpickles-marketplace"
  "claude-notifications-go"
)

plugins=(
  "superpowers@superpowers-marketplace"
  "elements-of-style@superpowers-marketplace"
  "git-workflows@technicalpickles-marketplace"
  "working-in-monorepos@technicalpickles-marketplace"
  "ci-cd-tools@technicalpickles-marketplace"
  "debugging-tools@technicalpickles-marketplace"
  "dev-tools@technicalpickles-marketplace"
  "superpowers-developing-for-claude-code@superpowers-marketplace"
  "document-skills@anthropic-agent-skills"
  "claude-notifications-go@claude-notifications-go"
)
```

Both installation steps check if marketplace/plugin already exists before adding, making them safe to run repeatedly.

## Role-Specific Configuration

Configuration varies by role following existing dotfiles pattern:

### settings.base.json - Shared across all environments

```json
{
  "statusLine": {
    "type": "command",
    "command": "npx -y @owloops/claude-powerline@latest --style=capsule"
  },
  "includeCoAuthoredBy": false,
  "alwaysThinkingEnabled": false,
  "enabledPlugins": {
    "superpowers@superpowers-marketplace": true,
    "elements-of-style@superpowers-marketplace": true
  }
}
```

### settings.work.json - Work-specific overrides

```json
{
  "enabledPlugins": {
    "some-work-specific-plugin@marketplace": true
  }
}
```

### permissions.json - Base permissions

Common permissions everyone gets (skills, web domains, basic bash commands).

### permissions.work.json - Work-specific additions

```json
[
  "Bash(bin/rspec:*)",
  "Bash(bin/rubocop:*)",
  "Bash(bundle exec rspec:*)",
  "Bash(bundle exec rubocop:*)",
  "Bash(bundle install)"
]
```

The script merges `permissions.json + permissions.$ROLE.json` into the `permissions.allow` array.

## Integration with install.sh

Add to existing `install.sh` after gitconfig setup:

```bash
# Setup Claude Code configuration
if command_available claude; then
  echo "Configuring Claude Code..."
  bash "$DIR/claudeconfig.sh"
else
  echo "Claude Code not installed, skipping configuration"
fi
```

## Usage Workflow

### Initial Setup

```bash
git clone https://github.com/technicalpickles/dotfiles ~/.pickles
~/.pickles/install.sh
```

### Manual Regeneration

```bash
# When you modify claude/*.json files or switch roles
cd ~/workspace/dotfiles
./claudeconfig.sh
```

### What Gets Committed

- ✅ `claudeconfig.sh` - Generator script
- ✅ `claude/*.json` - All settings/permissions fragments
- ✅ `CLAUDE.md` - Global instructions (already tracked)
- ✅ `commands/` - Custom slash commands (already tracked)

### What Stays Local

- AWS credentials in settings.json
- Any machine-specific overrides manually added
- Session history, debug logs, etc.

Since `~/.claude/settings.json` is generated outside the repo, sensitive data won't be accidentally committed.

## Error Handling and Safety

### Prerequisite Checks

```bash
if ! command_available claude; then
  echo "Error: claude command not found"
  exit 1
fi

if ! command_available jq; then
  echo "Error: jq required for JSON merging"
  exit 1
fi
```

### Safe File Operations

- Generate to temporary file first
- Validate JSON syntax before overwriting
- Backup existing settings.json before first generation
- Atomic move from temp to final location

### Idempotency Guarantees

- Marketplace/plugin installation checks existence first
- Running script multiple times produces same result
- Safe to run during install.sh every time

### Failure Modes

- If `claude marketplace add` fails, continue with others (don't abort entire script)
- If JSON merge fails, preserve existing settings.json
- Clear error messages for common issues (missing files, bad JSON syntax)

### Verbose Output

```bash
echo "Detecting role: $DOTPICKLES_ROLE"
echo "Adding marketplaces..."
echo "Installing plugins..."
echo "Generating settings.json..."
echo "✓ Claude Code configuration complete"
```

## Implementation Notes

- Follow patterns from `gitconfig.sh` for consistency
- Use helper functions from `functions.sh` (`command_available`, `running_macos`, etc.)
- Match the style and verbosity of existing dotfiles scripts
- Test in devcontainer environment before deploying to main machine
