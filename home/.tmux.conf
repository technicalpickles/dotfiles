set -g mouse on

# Terminal title - updates Ghostty tab name
set -g set-titles on
set -g set-titles-string "#S"

# Escape exits copy mode (vim-style)
bind -T copy-mode-vi Escape send-keys -X cancel

# Auto-name new sessions after the directory they're started in
# Skips if: explicit name given (non-numeric), or started in ~/gt
set-hook -g session-created 'run-shell "~/.pickles/bin/tmux-auto-rename-session \"#{session_name}\" \"#{pane_current_path}\""'

# ============================================================================
# Plugins
# ============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

# Catppuccin theme
# https://github.com/catppuccin/tmux
set -g @plugin 'catppuccin/tmux#v2.1.3'

# ============================================================================
# Catppuccin Theme Configuration
# ============================================================================

# Color palette
set -g @catppuccin_flavor 'mocha'

# Window styling - rounded pills
set -g @catppuccin_window_status_style 'rounded'
set -g @catppuccin_window_number_position 'left'
set -g @catppuccin_window_flags 'none'

# Powerline-style separators
# Left separator empty to avoid cutoff at screen edge
set -g @catppuccin_status_left_separator ''
set -g @catppuccin_status_middle_separator ''
set -g @catppuccin_status_right_separator ''
set -g @catppuccin_status_connect_separator 'no'

# Center the window list
set -g status-justify absolute-centre

# Initialize plugins (must come before status bar config that uses plugin variables)
run '~/.tmux/plugins/tpm/tpm'

# ============================================================================
# Mouse Scroll Behavior (AFTER TPM to avoid plugin overrides)
# ============================================================================

# Set to "on" for macOS natural scrolling, "off" for traditional
set -g @natural-scrolling "on"

# Auto-enter copy mode on scroll up, pass through if program captures mouse
# The wheel events are swapped when natural scrolling is enabled
if-shell -F '#{==:#{@natural-scrolling},on}' {
  bind-key -n WheelDownPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"
  unbind-key -n WheelUpPane
  bind-key -T copy-mode-vi WheelDownPane send-keys -X halfpage-up
  bind-key -T copy-mode-vi WheelUpPane send-keys -X halfpage-down
} {
  bind-key -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"
  unbind-key -n WheelDownPane
  bind-key -T copy-mode-vi WheelUpPane send-keys -X halfpage-up
  bind-key -T copy-mode-vi WheelDownPane send-keys -X halfpage-down
}

# ============================================================================
# Status Bar Layout (AFTER plugin init so #{E:@catppuccin_*} variables exist)
# ============================================================================

# Left: session → icon → mode text (state-colored)
# Mocha palette: green=#a6e3a1, blue=#89b4fa, yellow=#f9e2af, red=#f38ba8, crust=#11111b
#
# Session name on surface background
set -g @_session_text "#[bg=#313244]#[fg=#cdd6f4] #S "
# Terminal icon + mode text with state-aware color
set -g @_mode "#{?client_prefix,#[bg=#89b4fa]#[fg=#11111b]  WAIT ,#{?pane_in_mode,#[bg=#f9e2af]#[fg=#11111b]  COPY ,#{?pane_synchronized,#[bg=#f38ba8]#[fg=#11111b]  SYNC ,#[bg=#a6e3a1]#[fg=#11111b]  TMUX }}}"

set -g status-left "#{E:@_session_text}#{E:@_mode}#[default]"
set -g status-left-length 100

# Right: Claude spend + time
# Claude spend: pale green text on surface background
set -g status-right "#[bg=#313244,fg=#a6e3a1] ☉ #(~/.pickles/bin/claude-spend-today) #[default]#{E:@catppuccin_status_date_time}"
set -g status-right-length 100
