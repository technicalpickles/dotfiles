# ============================================================================
# Prefix Key (set early so plugins like tmux-sensible detect it)
# ============================================================================
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

set -g mouse on

# ============================================================================
# Sesh - Smart Session Manager
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#recommended-tmux-settings
# ============================================================================

# Skip "kill-pane 1? (y/n)" confirmation prompt
bind-key x kill-pane

# Don't exit tmux when closing a session - sesh manages session switching
set -g detach-on-destroy off

# Override default last-session (prefix+L) to use sesh's smarter version
# Works correctly with detach-on-destroy off by tracking actual session history
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#last
bind -N "last-session (via sesh)" L run-shell "sesh last"

# Switch to the root session of current git worktree or repository
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#connect-to-root
bind -N "switch to root session (via sesh)" 9 run-shell "sesh connect --root $(pwd)"

# Sesh session picker with fzf - shows tmux sessions, configs, and zoxide dirs
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#tmux--fzf
# Keybindings in picker:
#   ^a = all sources    ^t = tmux sessions    ^g = configured sessions
#   ^x = zoxide dirs    ^d = kill session     ^f = find directories
bind-key "T" run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --no-sort --ansi --border-label ' sesh ' --prompt 'âš¡  ' \
    --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(âš¡  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ðŸªŸ  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(âš™ï¸  )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(ðŸ“  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(ðŸ”Ž  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(âš¡  )+reload(sesh list --icons)' \
    --preview-window 'right:55%' \
    --preview 'sesh preview {}'
)\""

# Start Claude Code in a new window from current directory
bind-key C new-window -c "#{pane_current_path}" "claude"

# New workspace session - fzf picker of repos/projects, creates tmux session in ~/gt
bind-key N run-shell "pt workspaces --connect \"$(pt workspaces --color | fzf-tmux -p 80%,70% --ansi --prompt 'workspace> ' | awk '{print $1}')\""

# Word separators for double-click selection
# Minimal set so paths, URLs, and identifiers select as whole words:
#   âœ“ snake_case_names
#   âœ“ hyphen-separated-ids
#   âœ“ /full/file/paths
#   âœ“ https://example.com/full/urls
#   âœ“ user@hostname
#   âœ“ 5.52 (but not comma in "5.52, 5.41")
set -g word-separators " \t,"

# Terminal title - updates Ghostty tab name
set -g set-titles on
set -g set-titles-string "#S"

# Escape exits copy mode (vim-style)
bind -T copy-mode-vi Escape send-keys -X cancel

# Mouse selection copies but stays in copy mode (for tmux-open 'o' to work)
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-no-clear

# Double-click selects word, copies, and opens if URL (otherwise just copies)
bind -n DoubleClick1Pane select-pane \; copy-mode -M \; send-keys -X select-word \; send-keys -X copy-pipe-and-cancel '~/.pickles/bin/tmux-smart-open'

# Auto-name new sessions after the directory they're started in
# Skips if session was explicitly named (non-numeric name)
set-hook -g session-created 'run-shell "~/.pickles/bin/tmux-auto-rename-session \"#{session_name}\" \"#{pane_current_path}\""'

# ============================================================================
# Plugins
# ============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

# Catppuccin theme
# https://github.com/catppuccin/tmux
set -g @plugin 'catppuccin/tmux#v2.1.3'

# ============================================================================
# Catppuccin Theme Configuration
# ============================================================================

# Color palette
set -g @catppuccin_flavor 'mocha'

# Window styling - rounded pills
set -g @catppuccin_window_status_style 'rounded'
set -g @catppuccin_window_number_position 'left'
set -g @catppuccin_window_flags 'none'

# Powerline-style separators
# Left separator empty to avoid cutoff at screen edge
set -g @catppuccin_status_left_separator ''
set -g @catppuccin_status_middle_separator ''
set -g @catppuccin_status_right_separator ''
set -g @catppuccin_status_connect_separator 'no'

# Center the window list
set -g status-justify absolute-centre

# Initialize plugins (must come before status bar config that uses plugin variables)
run '~/.tmux/plugins/tpm/tpm'

# Override tmux-sensible's obsolete reattach-to-user-namespace workaround
#
# Problem: tmux-sensible auto-sets default-command to:
#   "reattach-to-user-namespace -l $SHELL"
# But $SHELL resolves to /bin/sh in tmux's server context (not fish), so
# panes launch /bin/sh instead of the configured default-shell.
#
# History: reattach-to-user-namespace was needed on older macOS because tmux's
# server detaches from the user's "bootstrap namespace", breaking clipboard
# access (pbcopy/pbpaste). Modern tmux (2.6+, 2017) has native clipboard
# support via set-clipboard, making this workaround obsolete.
#
# Decision: We unconditionally disable this since we target modern tmux.
# If clipboard breaks on ancient tmux, the fix would be:
#   set -g default-command "reattach-to-user-namespace -l /opt/homebrew/bin/fish"
set -g default-command ""

# ============================================================================
# Mouse Scroll Behavior (AFTER TPM to avoid plugin overrides)
# ============================================================================

# Set to "on" for macOS natural scrolling, "off" for traditional
set -g @natural-scrolling "on"

# Auto-enter copy mode on scroll up, pass through if program captures mouse
# The wheel events are swapped when natural scrolling is enabled
if-shell -F '#{==:#{@natural-scrolling},on}' {
  bind-key -n WheelDownPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"
  unbind-key -n WheelUpPane
  bind-key -T copy-mode-vi WheelDownPane send-keys -X halfpage-up
  bind-key -T copy-mode-vi WheelUpPane send-keys -X halfpage-down
} {
  bind-key -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"
  unbind-key -n WheelDownPane
  bind-key -T copy-mode-vi WheelUpPane send-keys -X halfpage-up
  bind-key -T copy-mode-vi WheelDownPane send-keys -X halfpage-down
}

# ============================================================================
# Status Bar Layout (AFTER plugin init so #{E:@catppuccin_*} variables exist)
# ============================================================================

# Left: session pill â†’ mode pill (state-colored)
# Mocha palette: green=#a6e3a1, blue=#89b4fa, yellow=#f9e2af, red=#f38ba8
#               crust=#11111b, surface0=#313244, text=#cdd6f4, mantle=#181825
#
# Pill glyphs (user pastes actual nerd font chars)
# Some need extra space to avoid being too close to text
set -g @_pill_left "î‚¶"
set -g @_pill_right "î‚´"
set -g @_icon_session "ï’‰ " # nf-oct-terminal
set -g @_icon_mode "î«¸ " # nf-cod-gear
set -g @_icon_spend "ï…• " # nf-fa-dollar_sign
set -g @_icon_time "ó°ƒ­ " # nf-oct-calendar
#
# Session pill: blue accent, icon only with right rounded cap
set -g @_session_pill "#[fg=#11111b,bg=#89b4fa] #{@_icon_session} #S #[fg=#89b4fa,bg=#181825]#{@_pill_right}#[default]"
# Mode pills: each state as separate variable to avoid comma parsing issues
set -g @_mode_wait "#[fg=#89b4fa,bg=#181825]#{@_pill_left}#[fg=#11111b,bg=#89b4fa] #{@_icon_mode} WAIT #[fg=#89b4fa,bg=#181825]#{@_pill_right}#[default]"
set -g @_mode_copy "#[fg=#f9e2af,bg=#181825]#{@_pill_left}#[fg=#11111b,bg=#f9e2af] #{@_icon_mode} COPY #[fg=#f9e2af,bg=#181825]#{@_pill_right}#[default]"
set -g @_mode_sync "#[fg=#f38ba8,bg=#181825]#{@_pill_left}#[fg=#11111b,bg=#f38ba8] #{@_icon_mode} SYNC #[fg=#f38ba8,bg=#181825]#{@_pill_right}#[default]"
set -g @_mode_tmux "#[fg=#a6e3a1,bg=#181825]#{@_pill_left}#[fg=#11111b,bg=#a6e3a1] #{@_icon_mode} TMUX #[fg=#a6e3a1,bg=#181825]#{@_pill_right}#[default]"
set -g @_mode_pill "#{?client_prefix,#{E:@_mode_wait},#{?pane_in_mode,#{E:@_mode_copy},#{?pane_synchronized,#{E:@_mode_sync},#{E:@_mode_tmux}}}}"

set -g status-left "#{E:@_session_pill} #{E:@_mode_pill}"
set -g status-left-length 100

# Right: Claude spend pill + time pill
# Claude spend: green accent pill
set -g @_spend_pill "#[fg=#a6e3a1,bg=#181825]#{@_pill_left}#[fg=#11111b,bg=#a6e3a1] #{@_icon_spend} #[fg=#cdd6f4,bg=#313244] #(~/.pickles/bin/claude-spend-today) #[fg=#313244,bg=#181825]#{@_pill_right}#[default]"
# Date/time: sky blue accent, rounded left only (overrides catppuccin triangle)
set -g @_time_pill "#[fg=#74c7ec,bg=#181825]#{@_pill_left}#[fg=#11111b,bg=#74c7ec] #{@_icon_time} #[fg=#cdd6f4,bg=#313244]#{E:@catppuccin_date_time_text}#[fg=#313244,bg=#181825]#{@_pill_right}#[default]"

set -g status-right "#{E:@_spend_pill} #{E:@_time_pill}"
set -g status-right-length 100

# ============================================================================
# Session Chooser (prefix+s) - Pillbox styled
# ============================================================================
# Format: [windows pill]  (session name shown by tmux prefix)
# Colors: green=attached, blue=detached
set -g @_icon_windows "ó±‚¬ " # nf-md-dock_window
set -g @_chooser_format "\
#{?session_attached,#[fg=#a6e3a1],#[fg=#89b4fa]}\
#{@_pill_left}\
#{?session_attached,#[fg=#11111b]#[bg=#a6e3a1],#[fg=#11111b]#[bg=#89b4fa]} \
#{session_windows} #{@_icon_windows}\
#{?session_attached,#[fg=#a6e3a1],#[fg=#89b4fa]}#[bg=default]\
#{@_pill_right}#[default]"

bind-key s choose-tree -Zs -F "#{E:@_chooser_format}"
bind-key S choose-tree -Zs -F "#{E:@_chooser_format}"
