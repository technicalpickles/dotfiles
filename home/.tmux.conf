set -g mouse on

# ============================================================================
# Sesh - Smart Session Manager
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#recommended-tmux-settings
# ============================================================================

# Skip "kill-pane 1? (y/n)" confirmation prompt
bind-key x kill-pane

# Don't exit tmux when closing a session - sesh manages session switching
set -g detach-on-destroy off

# Override default last-session (prefix+L) to use sesh's smarter version
# Works correctly with detach-on-destroy off by tracking actual session history
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#last
bind -N "last-session (via sesh)" L run-shell "sesh last"

# Switch to the root session of current git worktree or repository
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#connect-to-root
bind -N "switch to root session (via sesh)" 9 run-shell "sesh connect --root $(pwd)"

# Sesh session picker with fzf - shows tmux sessions, configs, and zoxide dirs
# https://github.com/joshmedeski/sesh?tab=readme-ov-file#tmux--fzf
# Keybindings in picker:
#   ^a = all sources    ^t = tmux sessions    ^g = configured sessions
#   ^x = zoxide dirs    ^d = kill session     ^f = find directories
bind-key "T" run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --preview-window 'right:55%' \
    --preview 'sesh preview {}'
)\""

# Word separators for double-click selection
# Minimal set so paths, URLs, and identifiers select as whole words:
#   ‚úì snake_case_names
#   ‚úì hyphen-separated-ids
#   ‚úì /full/file/paths
#   ‚úì https://example.com/full/urls
#   ‚úì user@hostname
#   ‚úì 5.52 (but not comma in "5.52, 5.41")
set -g word-separators " \t,"

# Terminal title - updates Ghostty tab name
set -g set-titles on
set -g set-titles-string "#S"

# Escape exits copy mode (vim-style)
bind -T copy-mode-vi Escape send-keys -X cancel

# Auto-name new sessions after the directory they're started in
# Skips if session was explicitly named (non-numeric name)
set-hook -g session-created 'run-shell "~/.pickles/bin/tmux-auto-rename-session \"#{session_name}\" \"#{pane_current_path}\""'

# ============================================================================
# Plugins
# ============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

# Catppuccin theme
# https://github.com/catppuccin/tmux
set -g @plugin 'catppuccin/tmux#v2.1.3'

# ============================================================================
# Catppuccin Theme Configuration
# ============================================================================

# Color palette
set -g @catppuccin_flavor 'mocha'

# Window styling - rounded pills
set -g @catppuccin_window_status_style 'rounded'
set -g @catppuccin_window_number_position 'left'
set -g @catppuccin_window_flags 'none'

# Powerline-style separators
# Left separator empty to avoid cutoff at screen edge
set -g @catppuccin_status_left_separator ''
set -g @catppuccin_status_middle_separator ''
set -g @catppuccin_status_right_separator ''
set -g @catppuccin_status_connect_separator 'no'

# Center the window list
set -g status-justify absolute-centre

# Initialize plugins (must come before status bar config that uses plugin variables)
run '~/.tmux/plugins/tpm/tpm'

# Override tmux-sensible's obsolete reattach-to-user-namespace workaround
#
# Problem: tmux-sensible auto-sets default-command to:
#   "reattach-to-user-namespace -l $SHELL"
# But $SHELL resolves to /bin/sh in tmux's server context (not fish), so
# panes launch /bin/sh instead of the configured default-shell.
#
# History: reattach-to-user-namespace was needed on older macOS because tmux's
# server detaches from the user's "bootstrap namespace", breaking clipboard
# access (pbcopy/pbpaste). Modern tmux (2.6+, 2017) has native clipboard
# support via set-clipboard, making this workaround obsolete.
#
# Decision: We unconditionally disable this since we target modern tmux.
# If clipboard breaks on ancient tmux, the fix would be:
#   set -g default-command "reattach-to-user-namespace -l /opt/homebrew/bin/fish"
set -g default-command ""

# ============================================================================
# Mouse Scroll Behavior (AFTER TPM to avoid plugin overrides)
# ============================================================================

# Set to "on" for macOS natural scrolling, "off" for traditional
set -g @natural-scrolling "on"

# Auto-enter copy mode on scroll up, pass through if program captures mouse
# The wheel events are swapped when natural scrolling is enabled
if-shell -F '#{==:#{@natural-scrolling},on}' {
  bind-key -n WheelDownPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"
  unbind-key -n WheelUpPane
  bind-key -T copy-mode-vi WheelDownPane send-keys -X halfpage-up
  bind-key -T copy-mode-vi WheelUpPane send-keys -X halfpage-down
} {
  bind-key -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "copy-mode -e"
  unbind-key -n WheelDownPane
  bind-key -T copy-mode-vi WheelUpPane send-keys -X halfpage-up
  bind-key -T copy-mode-vi WheelDownPane send-keys -X halfpage-down
}

# ============================================================================
# Status Bar Layout (AFTER plugin init so #{E:@catppuccin_*} variables exist)
# ============================================================================

# Left: session ‚Üí icon ‚Üí mode text (state-colored)
# Mocha palette: green=#a6e3a1, blue=#89b4fa, yellow=#f9e2af, red=#f38ba8, crust=#11111b
#
# Session name on surface background
set -g @_session_text "#[bg=#313244]#[fg=#cdd6f4] #S "
# Terminal icon + mode text with state-aware color
set -g @_mode "#{?client_prefix,#[bg=#89b4fa]#[fg=#11111b]  WAIT ,#{?pane_in_mode,#[bg=#f9e2af]#[fg=#11111b]  COPY ,#{?pane_synchronized,#[bg=#f38ba8]#[fg=#11111b]  SYNC ,#[bg=#a6e3a1]#[fg=#11111b]  TMUX }}}"

set -g status-left "#{E:@_session_text}#{E:@_mode}#[default]"
set -g status-left-length 100

# Right: Claude spend + time
# Claude spend: pale green text on surface background
set -g status-right "#[bg=#313244,fg=#a6e3a1] ‚òâ #(~/.pickles/bin/claude-spend-today) #[default]#{E:@catppuccin_status_date_time}"
set -g status-right-length 100
