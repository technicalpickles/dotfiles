#!/usr/bin/env bash
set -euo pipefail

# monorepo-init: Auto-detect subprojects and generate .monorepo.json
#
# Usage:
#   bin/monorepo-init              # Output JSON to stdout
#   bin/monorepo-init --dry-run    # Same as above
#   bin/monorepo-init --write      # Write to .monorepo.json

show_usage() {
  cat << EOF
Usage: monorepo-init [OPTIONS]

Auto-detect subprojects and generate .monorepo.json

OPTIONS:
  --dry-run    Output JSON to stdout (default)
  --write      Write to .monorepo.json
  -h, --help   Show this help

DETECTION:
  Scans for package manager artifacts:
  - package.json (Node)
  - Gemfile (Ruby)
  - go.mod (Go)
  - pyproject.toml, setup.py, requirements.txt (Python)
  - Cargo.toml (Rust)
  - build.gradle, pom.xml (Java)

EXAMPLES:
  bin/monorepo-init --dry-run
  bin/monorepo-init | jq .
  bin/monorepo-init --write
EOF
}

# Parse arguments
MODE="dry-run"
while [[ $# -gt 0 ]]; do
  case $1 in
    --write)
      MODE="write"
      shift
      ;;
    --dry-run)
      MODE="dry-run"
      shift
      ;;
    -h | --help)
      show_usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      show_usage >&2
      exit 1
      ;;
  esac
done

# Find repo root
find_repo_root() {
  git rev-parse --show-toplevel 2> /dev/null || {
    echo "Error: Not in a git repository" >&2
    exit 1
  }
}

# Detect subproject type from artifacts
detect_type() {
  local dir="$1"

  if [[ -f "$dir/package.json" ]]; then
    echo "node"
  elif [[ -f "$dir/Gemfile" ]]; then
    echo "ruby"
  elif [[ -f "$dir/go.mod" ]]; then
    echo "go"
  elif [[ -f "$dir/pyproject.toml" ]] || [[ -f "$dir/setup.py" ]] || [[ -f "$dir/requirements.txt" ]]; then
    echo "python"
  elif [[ -f "$dir/Cargo.toml" ]]; then
    echo "rust"
  elif [[ -f "$dir/build.gradle" ]] || [[ -f "$dir/pom.xml" ]]; then
    echo "java"
  else
    echo "unknown"
  fi
}

# Find all artifact files
find_artifacts() {
  local root="$1"

  # Check if fd is available (faster)
  if command -v fd &> /dev/null; then
    fd -t f '(package\.json|Gemfile|go\.mod|pyproject\.toml|setup\.py|requirements\.txt|Cargo\.toml|build\.gradle|pom\.xml)$' "$root"
  else
    # Fallback to find
    find "$root" -type f \( \
      -name 'package.json' -o \
      -name 'Gemfile' -o \
      -name 'go.mod' -o \
      -name 'pyproject.toml' -o \
      -name 'setup.py' -o \
      -name 'requirements.txt' -o \
      -name 'Cargo.toml' -o \
      -name 'build.gradle' -o \
      -name 'pom.xml' \
      \)
  fi
}

# TODO: Implementation in next tasks
echo "Not yet implemented" >&2
exit 1
