#!/usr/bin/env bash
set -euo pipefail

PROJECTS_DIR="${HOME}/.claude/projects"
TODAY=$(date +%Y-%m-%d)

if [[ ! -d "$PROJECTS_DIR" ]]; then
  echo "\$0.00"
  exit 0
fi

# Pricing per million tokens (using Opus as default since that's what's being used)
# TODO: Could extract model from each entry for precise pricing
result=$(find "$PROJECTS_DIR" -name "*.jsonl" -mtime -2 -print0 2> /dev/null \
  | xargs -0 grep -h "\"timestamp\":\"${TODAY}" 2> /dev/null \
  | grep '"usage":' \
  | jq -s '
        # Opus pricing per million tokens
        def pricing: {input: 15, output: 75, cache_create: 18.75, cache_read: 1.5};

        map(.message.usage // empty) |
        {
            input: (map(.input_tokens // 0) | add // 0),
            output: (map(.output_tokens // 0) | add // 0),
            cache_create: (map(.cache_creation_input_tokens // 0) | add // 0),
            cache_read: (map(.cache_read_input_tokens // 0) | add // 0)
        } |
        . + {
            total_tokens: (.input + .output + .cache_create + .cache_read),
            cost: (
                (.input * pricing.input / 1000000) +
                (.output * pricing.output / 1000000) +
                (.cache_create * pricing.cache_create / 1000000) +
                (.cache_read * pricing.cache_read / 1000000)
            )
        }
    ')

cost=$(echo "$result" | jq -r '.cost')
tokens=$(echo "$result" | jq -r '.total_tokens')

# Format output
if (($(echo "$cost < 0.01" | bc -l))); then
  echo "<\$0.01"
else
  printf "\$%.2f\n" "$cost"
fi
