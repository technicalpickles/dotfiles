#!/usr/bin/env bash
# bedrock-claude-models - Query AWS Bedrock for available Claude models and generate environment variables
#
# Usage:
#   ./bin/bedrock-claude-models [--eval] [--pricing] [--json] [--region REGION] [--default MODEL]
#
# Options:
#   --eval         Output only eval-able environment variable exports (Fish shell format)
#   --pricing      Show side-by-side comparison of models with pricing (NOTE: pricing is hardcoded)
#   --json         Output JSON for ~/.claude/settings.json env section
#   --region       AWS region to query (defaults to current AWS region)
#   --default      Which model to use as default: sonnet (default), opus, or haiku
#   --help         Show this help message
#
# Note on Pricing:
#   AWS Bedrock does not expose pricing via API. Pricing data is stored in config/bedrock-claude-pricing.json.
#   To update pricing, save AWS pricing page as Pricing.html and run: bin/bedrock-parse-pricing --save
#   Always verify current pricing at https://aws.amazon.com/bedrock/pricing/
#
# Examples:
#   # Show all info (default)
#   ./bin/bedrock-claude-models
#
#   # Generate eval-able exports only
#   ./bin/bedrock-claude-models --eval
#
#   # Set environment variables in Fish shell
#   eval (./bin/bedrock-claude-models --eval)
#
#   # Use Opus as the default model
#   ./bin/bedrock-claude-models --default opus
#
#   # Show pricing comparison table
#   ./bin/bedrock-claude-models --pricing
#
#   # Generate JSON for Claude settings with Haiku as default
#   ./bin/bedrock-claude-models --json --default haiku

set -euo pipefail

# Function to show help
show_help() {
  grep '^#' "$0" | grep -v '#!/' | sed 's/^# //' | sed 's/^#//'
  exit 0
}

# Parse command line arguments
SHOW_EVAL_ONLY=false
SHOW_PRICING=false
SHOW_JSON=false
AWS_REGION="${AWS_REGION:-}"
DEFAULT_MODEL="sonnet"

while [[ $# -gt 0 ]]; do
  case $1 in
    --help | -h)
      show_help
      ;;
    --eval)
      SHOW_EVAL_ONLY=true
      shift
      ;;
    --pricing)
      SHOW_PRICING=true
      shift
      ;;
    --json)
      SHOW_JSON=true
      shift
      ;;
    --region)
      AWS_REGION="$2"
      shift 2
      ;;
    --default)
      DEFAULT_MODEL="$2"
      if [[ "$DEFAULT_MODEL" != "sonnet" ]] && [[ "$DEFAULT_MODEL" != "opus" ]] && [[ "$DEFAULT_MODEL" != "haiku" ]]; then
        echo "Error: --default must be one of: sonnet, opus, haiku" >&2
        exit 1
      fi
      shift 2
      ;;
    *)
      echo "Unknown option: $1" >&2
      echo "Run with --help for usage information" >&2
      exit 1
      ;;
  esac
done

# Determine AWS region
if [[ -z "$AWS_REGION" ]]; then
  AWS_REGION=$(aws configure get region || echo "us-east-1")
fi

# Check if AWS CLI is available
if ! command -v aws &> /dev/null; then
  echo "Error: aws CLI not found. Please install it first." >&2
  exit 1
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
  echo "Error: jq not found. Please install it first." >&2
  exit 1
fi

# Function to get available Claude models from Bedrock
# Uses inference profiles to get both global and regional model IDs
get_claude_models() {
  local region=$1
  aws bedrock list-inference-profiles \
    --region "$region" \
    --output json 2> /dev/null \
    | jq -r '.inferenceProfileSummaries[] | select(.inferenceProfileId | contains("claude")) | .inferenceProfileId' \
    | sort -V
}

# Function to extract model info
parse_model_id() {
  local model_id=$1
  local scope=$(echo "$model_id" | cut -d. -f1)
  local family=$(echo "$model_id" | grep -oE "(sonnet|haiku|opus)" || echo "unknown")
  local version=$(echo "$model_id" | grep -oE "[0-9]+-[0-9]+-[0-9]+" || echo "")
  echo "$scope|$family|$version|$model_id"
}

# Function to get pricing for a model
# Reads from config/bedrock-claude-pricing.json
get_pricing() {
  local model_id=$1
  local pricing_file="$(dirname "$0")/../config/bedrock-claude-pricing.json"

  # If pricing file doesn't exist, return unavailable
  if [[ ! -f "$pricing_file" ]]; then
    echo "Pricing unavailable (run: bin/bedrock-parse-pricing --save)"
    return
  fi

  # Try to match model ID to pricing data
  # Match by key patterns in the model ID
  local input_price=""
  local output_price=""

  case "$model_id" in
    # Claude 4.5 models
    *opus-4-5*)
      input_price=$(jq -r '.models["Claude Opus 4.5"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude Opus 4.5"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    *sonnet-4-5*)
      # Check for long context variant
      if [[ "$model_id" == *"long"* ]]; then
        input_price=$(jq -r '.models["Claude Sonnet 4.5 - Long Context"].inputPerMTok // "N/A"' "$pricing_file")
        output_price=$(jq -r '.models["Claude Sonnet 4.5 - Long Context"].outputPerMTok // "N/A"' "$pricing_file")
      else
        input_price=$(jq -r '.models["Claude Sonnet 4.5"].inputPerMTok // "N/A"' "$pricing_file")
        output_price=$(jq -r '.models["Claude Sonnet 4.5"].outputPerMTok // "N/A"' "$pricing_file")
      fi
      ;;
    *haiku-4-5*)
      input_price=$(jq -r '.models["Claude Haiku 4.5"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude Haiku 4.5"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    # Claude 4.1 models
    *opus-4-1*)
      input_price=$(jq -r '.models["Claude Opus 4.1"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude Opus 4.1"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    # Claude 4 models
    *opus-4*)
      input_price=$(jq -r '.models["Claude Opus 4"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude Opus 4"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    *sonnet-4*)
      if [[ "$model_id" == *"long"* ]]; then
        input_price=$(jq -r '.models["Claude Sonnet 4 - Long Context"].inputPerMTok // "N/A"' "$pricing_file")
        output_price=$(jq -r '.models["Claude Sonnet 4 - Long Context"].outputPerMTok // "N/A"' "$pricing_file")
      else
        input_price=$(jq -r '.models["Claude Sonnet 4"].inputPerMTok // "N/A"' "$pricing_file")
        output_price=$(jq -r '.models["Claude Sonnet 4"].outputPerMTok // "N/A"' "$pricing_file")
      fi
      ;;
    # Claude 3.7 models
    *3-7-sonnet* | *sonnet-3-7*)
      input_price=$(jq -r '.models["Claude 3.7 Sonnet"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude 3.7 Sonnet"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    # Claude 3.5 models
    *3-5-sonnet* | *sonnet-3-5*)
      input_price=$(jq -r '.models["Claude 3.5 Sonnet"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude 3.5 Sonnet"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    *3-5-haiku* | *haiku-3-5*)
      input_price=$(jq -r '.models["Claude 3.5 Haiku"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude 3.5 Haiku"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    # Claude 3 models
    *claude-3-opus*)
      input_price=$(jq -r '.models["Claude 3 Opus"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude 3 Opus"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    *claude-3-sonnet*)
      input_price=$(jq -r '.models["Claude 3 Sonnet"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude 3 Sonnet"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    *claude-3-haiku*)
      input_price=$(jq -r '.models["Claude 3 Haiku"].inputPerMTok // "N/A"' "$pricing_file")
      output_price=$(jq -r '.models["Claude 3 Haiku"].outputPerMTok // "N/A"' "$pricing_file")
      ;;
    *)
      echo "Pricing unavailable"
      return
      ;;
  esac

  if [[ "$input_price" == "N/A" ]] || [[ "$output_price" == "N/A" ]]; then
    echo "Pricing unavailable"
  else
    printf "Input: \$%.2f/MTok | Output: \$%.2f/MTok" "$input_price" "$output_price"
  fi
}

# Get all Claude models
if [[ "$SHOW_EVAL_ONLY" == false ]] && [[ "$SHOW_JSON" == false ]]; then
  echo "# Querying AWS Bedrock in region: $AWS_REGION" >&2
  echo "" >&2
fi

MODELS=$(get_claude_models "$AWS_REGION")

if [[ -z "$MODELS" ]]; then
  echo "Error: No Claude models found in region $AWS_REGION" >&2
  exit 1
fi

# Parse and categorize models (bash 3 compatible - use separate variables instead of associative arrays)
LATEST_OPUS_GLOBAL=""
LATEST_OPUS_US=""
LATEST_OPUS_OTHER=""
LATEST_SONNET_GLOBAL=""
LATEST_SONNET_US=""
LATEST_SONNET_OTHER=""
LATEST_HAIKU_GLOBAL=""
LATEST_HAIKU_US=""
LATEST_HAIKU_OTHER=""
ALL_HAIKU_MODELS=""

while IFS= read -r model_id; do
  IFS='|' read -r scope family version full_id <<< "$(parse_model_id "$model_id")"

  case "$family" in
    opus)
      if [[ "$scope" == "global" ]]; then
        if [[ -z "$LATEST_OPUS_GLOBAL" ]] || [[ "$version" > "$(echo "$LATEST_OPUS_GLOBAL" | cut -d'|' -f3)" ]]; then
          LATEST_OPUS_GLOBAL="$scope|$family|$version|$full_id"
        fi
      elif [[ "$scope" == "us" ]]; then
        if [[ -z "$LATEST_OPUS_US" ]] || [[ "$version" > "$(echo "$LATEST_OPUS_US" | cut -d'|' -f3)" ]]; then
          LATEST_OPUS_US="$scope|$family|$version|$full_id"
        fi
      else
        if [[ -z "$LATEST_OPUS_OTHER" ]] || [[ "$version" > "$(echo "$LATEST_OPUS_OTHER" | cut -d'|' -f3)" ]]; then
          LATEST_OPUS_OTHER="$scope|$family|$version|$full_id"
        fi
      fi
      ;;
    sonnet)
      if [[ "$scope" == "global" ]]; then
        if [[ -z "$LATEST_SONNET_GLOBAL" ]] || [[ "$version" > "$(echo "$LATEST_SONNET_GLOBAL" | cut -d'|' -f3)" ]]; then
          LATEST_SONNET_GLOBAL="$scope|$family|$version|$full_id"
        fi
      elif [[ "$scope" == "us" ]]; then
        if [[ -z "$LATEST_SONNET_US" ]] || [[ "$version" > "$(echo "$LATEST_SONNET_US" | cut -d'|' -f3)" ]]; then
          LATEST_SONNET_US="$scope|$family|$version|$full_id"
        fi
      else
        if [[ -z "$LATEST_SONNET_OTHER" ]] || [[ "$version" > "$(echo "$LATEST_SONNET_OTHER" | cut -d'|' -f3)" ]]; then
          LATEST_SONNET_OTHER="$scope|$family|$version|$full_id"
        fi
      fi
      ;;
    haiku)
      if [[ "$scope" == "global" ]]; then
        if [[ -z "$LATEST_HAIKU_GLOBAL" ]] || [[ "$version" > "$(echo "$LATEST_HAIKU_GLOBAL" | cut -d'|' -f3)" ]]; then
          LATEST_HAIKU_GLOBAL="$scope|$family|$version|$full_id"
        fi
      elif [[ "$scope" == "us" ]]; then
        if [[ -z "$LATEST_HAIKU_US" ]] || [[ "$version" > "$(echo "$LATEST_HAIKU_US" | cut -d'|' -f3)" ]]; then
          LATEST_HAIKU_US="$scope|$family|$version|$full_id"
        fi
      else
        if [[ -z "$LATEST_HAIKU_OTHER" ]] || [[ "$version" > "$(echo "$LATEST_HAIKU_OTHER" | cut -d'|' -f3)" ]]; then
          LATEST_HAIKU_OTHER="$scope|$family|$version|$full_id"
        fi
      fi
      # Track all haiku models for comparison
      if [[ -z "$ALL_HAIKU_MODELS" ]]; then
        ALL_HAIKU_MODELS="$scope|$family|$version|$full_id"
      else
        ALL_HAIKU_MODELS="$ALL_HAIKU_MODELS
$scope|$family|$version|$full_id"
      fi
      ;;
  esac
done <<< "$MODELS"

# Determine best models for each category
# Prefer global scope for all models to match Global Cross-region Inference pricing
OPUS_MODEL=""
SONNET_MODEL=""
HAIKU_MODEL=""

# Find best opus (prefer global scope)
if [[ -n "$LATEST_OPUS_GLOBAL" ]]; then
  IFS='|' read -r _ _ _ OPUS_MODEL <<< "$LATEST_OPUS_GLOBAL"
elif [[ -n "$LATEST_OPUS_US" ]]; then
  IFS='|' read -r _ _ _ OPUS_MODEL <<< "$LATEST_OPUS_US"
elif [[ -n "$LATEST_OPUS_OTHER" ]]; then
  IFS='|' read -r _ _ _ OPUS_MODEL <<< "$LATEST_OPUS_OTHER"
fi

# Find best sonnet (prefer global scope to match pricing tier)
if [[ -n "$LATEST_SONNET_GLOBAL" ]]; then
  IFS='|' read -r _ _ _ SONNET_MODEL <<< "$LATEST_SONNET_GLOBAL"
elif [[ -n "$LATEST_SONNET_US" ]]; then
  IFS='|' read -r _ _ _ SONNET_MODEL <<< "$LATEST_SONNET_US"
elif [[ -n "$LATEST_SONNET_OTHER" ]]; then
  IFS='|' read -r _ _ _ SONNET_MODEL <<< "$LATEST_SONNET_OTHER"
fi

# Find best haiku (prefer global scope to match pricing tier)
if [[ -n "$LATEST_HAIKU_GLOBAL" ]]; then
  IFS='|' read -r _ _ _ HAIKU_MODEL <<< "$LATEST_HAIKU_GLOBAL"
elif [[ -n "$LATEST_HAIKU_US" ]]; then
  IFS='|' read -r _ _ _ HAIKU_MODEL <<< "$LATEST_HAIKU_US"
elif [[ -n "$LATEST_HAIKU_OTHER" ]]; then
  IFS='|' read -r _ _ _ HAIKU_MODEL <<< "$LATEST_HAIKU_OTHER"
fi

# Show pricing table if requested
if [[ "$SHOW_PRICING" == true ]] && [[ "$SHOW_EVAL_ONLY" == false ]]; then
  PRICING_FILE="$(dirname "$0")/../config/bedrock-claude-pricing.json"
  if [[ -f "$PRICING_FILE" ]]; then
    LAST_UPDATED=$(jq -r '.lastUpdated // "unknown"' "$PRICING_FILE")
    echo "# Available Claude Models in $AWS_REGION" >&2
    echo "# NOTE: Pricing data was last updated $LAST_UPDATED. Verify at https://aws.amazon.com/bedrock/pricing/" >&2
  else
    echo "# Available Claude Models in $AWS_REGION" >&2
    echo "# NOTE: Pricing data not available. Run: bin/bedrock-parse-pricing --save" >&2
  fi
  echo "" >&2
  printf "%-60s %-15s %-40s\n" "Model ID" "Family" "Pricing (Approx.)" >&2
  printf "%-60s %-15s %-40s\n" "$(printf '%0.s-' {1..60})" "$(printf '%0.s-' {1..15})" "$(printf '%0.s-' {1..40})" >&2

  # Show all models
  while IFS= read -r model_id; do
    IFS='|' read -r scope family version full_id <<< "$(parse_model_id "$model_id")"
    pricing=$(get_pricing "$full_id")
    printf "%-60s %-15s %-40s\n" "$full_id" "$family" "$pricing" >&2
  done <<< "$MODELS"

  echo "" >&2
  echo "# Haiku Models Comparison (Small/Fast Models)" >&2
  echo "" >&2
  printf "%-10s %-50s %-40s\n" "Scope" "Model ID" "Pricing (Approx.)" >&2
  printf "%-10s %-50s %-40s\n" "$(printf '%0.s-' {1..10})" "$(printf '%0.s-' {1..50})" "$(printf '%0.s-' {1..40})" >&2

  # Process haiku models (bash 3 compatible - iterate over newline-separated string)
  while IFS='|' read -r scope family version full_id; do
    if [[ -n "$full_id" ]]; then
      pricing=$(get_pricing "$full_id")
      printf "%-10s %-50s %-40s\n" "$scope" "$full_id" "$pricing" >&2
    fi
  done <<< "$ALL_HAIKU_MODELS"

  echo "" >&2
fi

# Determine which model to use as default based on --default flag
case "$DEFAULT_MODEL" in
  opus)
    DEFAULT_MODEL_ID="$OPUS_MODEL"
    ;;
  haiku)
    DEFAULT_MODEL_ID="$HAIKU_MODEL"
    ;;
  sonnet | *)
    DEFAULT_MODEL_ID="$SONNET_MODEL"
    ;;
esac

# Output in requested format
if [[ "$SHOW_JSON" == true ]]; then
  # Generate JSON for Claude Code settings.json env section
  cat << EOF
{
  "env": {
    "ANTHROPIC_MODEL": "${DEFAULT_MODEL_ID}",
    "ANTHROPIC_SMALL_FAST_MODEL": "${HAIKU_MODEL}",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "${SONNET_MODEL}",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "${HAIKU_MODEL}",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "${OPUS_MODEL}"
  }
}
EOF
else
  # Output environment variables
  if [[ "$SHOW_EVAL_ONLY" == false ]]; then
    echo "# Selected Models:" >&2
    echo "#   Opus (highest capability):   $OPUS_MODEL" >&2
    echo "#   Sonnet (balanced):           $SONNET_MODEL" >&2
    echo "#   Haiku (fast/cost-effective): $HAIKU_MODEL" >&2
    echo "#   Default (--default $DEFAULT_MODEL): $DEFAULT_MODEL_ID" >&2
    echo "" >&2
    echo "# Fish shell - run: eval (./bin/bedrock-claude-models --eval)" >&2
    echo "" >&2
  fi

  # Generate Fish shell export statements
  echo "set -gx ANTHROPIC_MODEL '${DEFAULT_MODEL_ID}'"
  echo "set -gx ANTHROPIC_SMALL_FAST_MODEL '${HAIKU_MODEL}'"
  echo "set -gx ANTHROPIC_DEFAULT_SONNET_MODEL '${SONNET_MODEL}'"
  echo "set -gx ANTHROPIC_DEFAULT_HAIKU_MODEL '${HAIKU_MODEL}'"
  echo "set -gx ANTHROPIC_DEFAULT_OPUS_MODEL '${OPUS_MODEL}'"
fi
