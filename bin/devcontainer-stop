#!/usr/bin/env bash
# Stop and clean up the devcontainer

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

REMOVE_CONTAINER=false
REMOVE_VOLUMES=false

usage() {
  cat << EOF
Usage: $(basename "$0") [OPTIONS]

Stop the devcontainer and optionally remove it.

OPTIONS:
  -r, --remove        Remove the container after stopping
  -v, --volumes       Also remove volumes (requires --remove)
  -h, --help          Show this help message

EXAMPLES:
  # Just stop the container
  $(basename "$0")

  # Stop and remove the container
  $(basename "$0") --remove

  # Stop, remove container and volumes (clean slate)
  $(basename "$0") --remove --volumes

WORKFLOW:
  After stopping/removing, you can rebuild with:
    bin/devcontainer-build
    bin/devcontainer-run

  Or use the CLI directly:
    devcontainer up --workspace-folder . --remove-existing-container
EOF
}

while [[ $# -gt 0 ]]; do
  case $1 in
    -r | --remove)
      REMOVE_CONTAINER=true
      shift
      ;;
    -v | --volumes)
      REMOVE_VOLUMES=true
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      echo "Error: Unknown option $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ "$REMOVE_VOLUMES" == "true" && "$REMOVE_CONTAINER" == "false" ]]; then
  echo "Error: --volumes requires --remove" >&2
  exit 1
fi

echo "Stopping devcontainer..."
echo "Workspace: $REPO_ROOT"
echo

# Find the container for this workspace
CONTAINER_ID=$(docker ps -a --filter "label=devcontainer.local_folder=$REPO_ROOT" --format "{{.ID}}" | head -1)

if [[ -z "$CONTAINER_ID" ]]; then
  echo "No devcontainer found for this workspace"
  exit 0
fi

CONTAINER_NAME=$(docker inspect --format='{{.Name}}' "$CONTAINER_ID" | sed 's/^\///')
echo "Found container: $CONTAINER_NAME ($CONTAINER_ID)"
echo

# Stop the container
echo "Stopping container..."
docker stop "$CONTAINER_ID"
echo "âœ“ Container stopped"

if [[ "$REMOVE_CONTAINER" == "true" ]]; then
  echo
  echo "Removing container..."

  REMOVE_ARGS=()
  if [[ "$REMOVE_VOLUMES" == "true" ]]; then
    REMOVE_ARGS+=("-v")
    echo "  (including volumes)"
  fi

  docker rm "${REMOVE_ARGS[@]}" "$CONTAINER_ID"
  echo "âœ“ Container removed"
fi

echo
echo "Done! ðŸ›‘"
echo

if [[ "$REMOVE_CONTAINER" == "true" ]]; then
  echo "To rebuild and start fresh:"
  echo "  bin/devcontainer-build"
  echo "  bin/devcontainer-run"
else
  echo "To start the container again:"
  echo "  docker start $CONTAINER_ID"
  echo
  echo "To remove the container:"
  echo "  $(basename "$0") --remove"
fi
